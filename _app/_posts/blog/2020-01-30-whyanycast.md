---

layout: post
title: Why AnyCast
slug: whyanycast
date_published: 2020-01-30T00:10:38.000Z
date_updated: 2020-01-30T00:10:38.000Z
tags: 程式
category: programmer
---

## 自己公司拿來做技術評審的文檔和大家分享一下，已刪除部分敏感內容



## 為什麼要做這件事
* 公司基礎業務技術的第一塊磚，肯定要我來敲。

+ 同时支持 NS 接入。這樣可以随时切换到自建 NS。此外，支持 DNSSEC 也迫在眉睫。
+ 同时支持 IP 接入。我們需要看到 DNS 的 Anycast IPv4 和 IPv6 信息，这样可以安全地在根域名下使用第三方 DNS。對於業務的彈性配置擁有更多的資助選擇權。
### 強推 AnyCast 原因

Anycast 最初是在 RFC1546 中提出并定义的，根据 RFC1546 的说明 IPv4 的任播地址不同于 IPv4 的单播地址，它建议从 IPv4 的地址空间分配出一块独立的地址空间作为任播地址空间。
Anycast 提供的是一种无状态的、尽力而为的服务，目前对于 Anycast 的中文译称主要有任播、泛潘、选播等。任播的基本概念是从物理主机设备中分离出的逻辑服务标识符，任播地址可以根据服务类型来分配，使得网络服务担当一个逻辑主机的角色。
RFC1546 定义的这种任播没有得到广泛的使用，在 1998 年的 RFC2373 规定了 IPv6 寻址体系结构。在这个文档中改进了任播的定义：发送到一个任播地址的报文被传送到由该地址标识的接口之一(根据路由协议的距离量度最近的一个)。RFC2373 定义的 IPv6 的任播模型没有限制路由选择的下部结构，也没有限制可使用该服务的上部协议。
RFC3513 (废弃了 RFC 2373)中，进一步对任播进行了定义：任播地址被分配给两个以上的接口 (一般指不同 IP 地址的节点) ，而发送到这个地址上的分组被路由到最近的接口。这里最近可以是指路由器跳数、服务器负载、服务器吞吐量、客户和服务器之间的往返时间 (RTT，round trip time)、链路的可用带宽等特征值 (metric) 决定。
在实际应用中，任播 (Anycast) 是一种网络寻址和路由的策略。Anycast 采用将一个单播地址分配到处于 Internet 中多个不同物理位置的主机上，发送到这个主机的报文被网络路由到路由协议度量的最近的目标主机上。
![相关图片](https://www.networxsecurity.org/fileadmin/user_upload/images/2015-08/anycast.jpg)
例如：在 IP 网络上通过一个 Anycast 地址标识一组提供特定服务的主机，同时服务访问方并不关心提供服务的具体是哪一台主机（比如：DNS 或者镜像服务），访问该地址的报文可以被 IP 网络路由到这一组目标中的任何一台主机上。

### 總結優勢

1. 不同客户端将访问不同目的主机，此过程对客户端透明，从而实现了目的主机的负载均衡。
2. 当任意目的主机接入的网络出现故障，导致该目的主机不可达时，客户端请求可以在无人为干预的情况下自动被路由到目前可达的最近目的主机，在一定程度上为目标主机提供了冗余性。
3. 当目的主机受到 DoS 攻击而无法到达时，由于网络不可到达，客户端请求也将路由到其它目的主机上。而在 DDoS 攻击时，由于任播的负载均衡效应，避免了单台目的主机承受所有攻击流量，因此在一定程度上为目的主机提高了安全性。
4. 因为任播利用路由度量到最近的目的主机，提高了客户端响应速度。

### 總結劣勢
1. 使用任播中的共享单播地址不能作为客户端发起请求，因为请求的响应不一定能返回到发起的任播单播地址。但是在我們的實際業務需求中並不依賴於此。因此，目前任播仅适合一些特定的上层协议。从目前的实际应用来看，任播最广泛的应用是 DNS 的部署。


## 面臨的潛在問題
- 域名解析複雜，遷移時容易發生遺漏問題
- 域名緩存時間長，關鍵業務可能受到影響

### 應對措施
- 批量導出域名解析紀錄後仔細核對，敏捷遷移
- 再遷移前關閉 CDN 模式，使用直連解析狀態，待確定直連生效後進行 AnyCast 解析，可以確保無論解析到源站 IP 還是 AnyCast IP 均可以訪問業務
- 堤防惡意攻擊
